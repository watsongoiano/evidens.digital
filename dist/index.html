<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Check-up M√©dico Inteligente</title>
    <link rel="stylesheet" href="styles/tokens.css" />
    <link rel="stylesheet" href="styles/base.css" />
    <link rel="stylesheet" href="styles/components.css" />


</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Check-up M√©dico Inteligente</h1>
            <p>Analise e receba recomenda√ß√µes essenciais de forma clara e objetiva.</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">Dados do Paciente</h2>
                
                <form id="checkupForm">
                    <!-- Campo hidden para passar o risco PREVENT calculado -->
                    <input type="hidden" id="prevent_risk_10yr" name="prevent_risk_10yr" value="">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="idade">Idade</label>
                            <input type="number" id="idade" name="idade" min="18" max="120" required>
                        </div>
                        <div class="form-group">
                            <label for="sexo">Sexo</label>
                            <select id="sexo" name="sexo" required>
                                <option value="">Selecione...</option>
                                <option value="masculino">Masculino</option>
                                <option value="feminino">Feminino</option>
                            </select>
                        </div>
                    </div>

                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pais">Pa√≠s/Guideline base</label>
                            <select id="pais" name="pais" required>
                                <option value="BR">Brasil (SBIm/SBC/SBD)</option>
                                <option value="EUA">EUA (CDC/USPSTF/ADA)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Se√ß√£o Dados Cl√≠nicos para PREVENT -->
                    <div class="form-group">
                        <h4 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.2rem;">üìä Dados Cl√≠nicos (para c√°lculo de risco cardiovascular)</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="peso">Peso (kg)</label>
                                <input type="number" id="peso" name="peso" min="30" max="300" step="0.1" placeholder="Ex: 70.5">
                            </div>
                            <div class="form-group">
                                <label for="altura">Altura (cm)</label>
                                <input type="number" id="altura" name="altura" min="100" max="250" step="1" placeholder="Ex: 170">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pressao_sistolica">Press√£o Arterial Sist√≥lica (mmHg)</label>
                                <input type="number" id="pressao_sistolica" name="pressao_sistolica" min="90" max="200" placeholder="Ex: 140">
                            </div>
                            <div class="form-group">
                                <label for="pressao_diastolica">Press√£o Arterial Diast√≥lica (mmHg)</label>
                                <input type="number" id="pressao_diastolica" name="pressao_diastolica" min="50" max="120" placeholder="Ex: 90">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="colesterol_total">Colesterol Total (mg/dL)</label>
                                <input type="number" id="colesterol_total" name="colesterol_total" min="130" max="320" placeholder="Ex: 200">
                            </div>
                            <div class="form-group">
                                <label for="hdl_colesterol">HDL Colesterol (mg/dL)</label>
                                <input type="number" id="hdl_colesterol" name="hdl_colesterol" min="20" max="100" placeholder="Ex: 45">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="creatinina">Creatinina S√©rica (mg/dL)</label>
                                <input type="number" id="creatinina" name="creatinina" min="0.5" max="10" step="0.01" placeholder="Ex: 1.0">
                            </div>
                            <div class="form-group">
                                <label for="hemoglobina_glicada">HbA1c (%)</label>
                                <input type="number" id="hemoglobina_glicada" name="hemoglobina_glicada" min="4" max="15" step="0.1" placeholder="Ex: 7.0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Medica√ß√µes Espec√≠ficas</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="medicamento_hipertensao" name="medicamentos_estruturados" value="anti_hipertensivo">
                                    <label for="medicamento_hipertensao">Medicamentos Anti-hipertensivos</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="medicamento_estatina" name="medicamentos_estruturados" value="estatina">
                                    <label for="medicamento_estatina">Estatinas</label>
                                </div>
                            </div>
                        </div>
                    </div>

        <div class="form-group">
                        <label>Comorbidades</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="diabetes" name="comorbidades" value="diabetes_tipo_2">
                                <label for="diabetes">Diabetes Tipo 2</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="hipertensao" name="comorbidades" value="hipertensao">
                                <label for="hipertensao">Hipertens√£o</label>
                                <div class="checkbox-item" style="margin-left: 30px; margin-top: 8px;">
                                    <input type="checkbox" id="has_resistente" name="comorbidades" value="has_resistente">
                                    <label for="has_resistente">HAS Resistente</label>
                                </div>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="dislipidemia" name="comorbidades" value="dislipidemia">
                                <label for="dislipidemia">Dislipidemia</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drc" name="comorbidades" value="doenca_renal_cronica">
                                <label for="drc">Doen√ßa Renal Cr√¥nica</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cardiopatia" name="comorbidades" value="cardiopatia">
                                <label for="cardiopatia">Cardiopatia</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="obesidade" name="comorbidades" value="obesidade">
                                <label for="obesidade">Obesidade</label>
                            </div>
                        </div>
                        <div class="others-input">
                            <label for="outras_comorbidades">Outras comorbidades (descreva):</label>
                            <textarea id="outras_comorbidades" name="outras_comorbidades" placeholder="Ex: DPOC, artrite reumatoide, hipotireoidismo, depress√£o..."></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="medicacoes_uso_continuo">Medica√ß√µes de Uso Cont√≠nuo</label>
                        <textarea id="medicacoes_uso_continuo" name="medicacoes_uso_continuo" placeholder="Ex: Losartana 50mg 1x/dia, Enalapril 10mg 2x/dia, Hidroclorotiazida 25mg 1x/dia, Metformina 850mg 2x/dia, Sinvastatina 20mg 1x/dia..." style="min-height: 80px;"></textarea>
                        <small style="color: #6c757d; font-size: 0.85rem;">Liste todas as medica√ß√µes em uso cont√≠nuo com doses e frequ√™ncia</small>
                    </div>

                    <div class="form-group">
                        <label>Hist√≥ria Familiar</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="hf_cancer_mama" name="historia_familiar" value="cancer_mama">
                                <label for="hf_cancer_mama">C√¢ncer de Mama</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="hf_cancer_colorretal" name="historia_familiar" value="cancer_colorretal">
                                <label for="hf_cancer_colorretal">C√¢ncer Colorretal</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="hf_cancer_ovario" name="historia_familiar" value="cancer_ovario">
                                <label for="hf_cancer_ovario">C√¢ncer de Ov√°rio</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="hf_diabetes" name="historia_familiar" value="diabetes">
                                <label for="hf_diabetes">Diabetes</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="hf_cardiopatia" name="historia_familiar" value="cardiopatia">
                                <label for="hf_cardiopatia">Cardiopatia</label>
                            </div>
                        </div>
                        <div class="others-input">
                            <label for="outras_hf">Outras condi√ß√µes familiares (descreva):</label>
                            <textarea id="outras_hf" name="outras_hf" placeholder="Ex: c√¢ncer de pr√≥stata, AVC, doen√ßa de Alzheimer, aneurisma..."></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tabagismo">Tabagismo</label>
                            <select id="tabagismo" name="tabagismo">
                                <option value="nunca_fumou">Nunca fumou</option>
                                <option value="fumante_atual">Fumante atual</option>
                                <option value="ex_fumante">Ex-fumante</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="macos_ano">Ma√ßos-ano (se fumante/ex-fumante)</label>
                            <input type="number" id="macos_ano" name="macos_ano" min="0" max="200">
                        </div>
                    </div>

                    <div class="exam-history" id="examHistory" style="display: none;">
                        <h4>üìã Exames Anteriores</h4>
                        <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 15px;">
                            Anexe PDFs de exames j√° realizados para otimizar as recomenda√ß√µes
                        </p>
                        
                        <div class="pdf-upload-area" id="pdfUploadArea">
                            <div class="upload-zone" onclick="document.getElementById('pdfInput').click()">
                                <div class="upload-icon">üìÑ</div>
                                <p>Clique aqui ou arraste PDFs de exames</p>
                                <small>Formatos aceitos: PDF (m√°x. 10MB cada)</small>
                            </div>
                            <input type="file" id="pdfInput" multiple accept=".pdf" style="display: none;">
                        </div>
                        
                        <div id="uploadedFiles" class="uploaded-files"></div>
                        
                        <div class="processing-status" id="processingStatus" style="display: none;">
                            <div class="loading-spinner"></div>
                            <span>Processando exames com IA...</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn">Gerar Recomenda√ß√µes Inteligentes</button>
                        <button type="button" class="btn btn-secondary" id="toggleExamHistory">
                            üìÑ Anexar PDFs de Exames
                        </button>
                    </div>
                </form>
            </div>

            <div class="results-section">
                <h2 class="section-title">Recomenda√ß√µes Inteligentes</h2>
                
                <!-- Cartes de Risque Cardiovasculaire PREVENT -->
                <div class="prevent-risk-section" id="preventRiskSection" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.3rem;">ü´Ä Risco Cardiovascular (PREVENT 2024)</h3>
                    <div class="risk-cards">
                        <div class="risk-card">
                            <h4>Estimated 10-year<br>risk of CVD</h4>
                            <div class="risk-percentage" id="risk-10-year">--</div>
                        </div>
                        <div class="risk-card">
                            <h4>Estimated 30-year<br>risk of CVD</h4>
                            <div class="risk-percentage" id="risk-30-year">--</div>
                        </div>
                    </div>
                    <div class="risk-interpretation" id="riskInterpretation">
                        <p><strong>Interpreta√ß√£o:</strong> <span id="riskInterpretationText">Preencha os dados cl√≠nicos para calcular o risco.</span></p>
                    </div>
                </div>
                
                <div class="results-container" id="resultsContainer">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4"/>
                            <path d="M9 7V3a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"/>
                            <circle cx="12" cy="13" r="1"/>
                        </svg>
                        <p>Preencha os dados do paciente para gerar recomenda√ß√µes personalizadas de check-up.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer com cr√©ditos -->
    <footer style="background: #2d3748; color: white; text-align: center; padding: 20px; margin-top: 40px;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <p style="margin: 0; font-size: 0.9rem;">
                <strong>Sistema de Check-up M√©dico Inteligente</strong><br>
                Desenvolvido por <strong>Dr. Rodolfo Cambraia Frota</strong><br>
                CRM-GO: 26.815
            </p>
            <p style="margin: 10px 0 0 0; font-size: 0.8rem; color: #a0aec0;">
                Baseado nos principais guidelines m√©dicos internacionais (USPSTF, ADA, CDC, KDIGO)
            </p>
        </div>
    </footer>

    <script>
        // Vari√°veis globais
        let examHistory = [];
        let uploadedFiles = [];
        let lastRecommendations = [];

        // Toggle da se√ß√£o de exames
        document.getElementById('toggleExamHistory').addEventListener('click', function() {
            const examHistory = document.getElementById('examHistory');
            if (examHistory.style.display === 'none') {
                examHistory.style.display = 'block';
                this.textContent = 'üìÑ Ocultar PDFs de Exames';
            } else {
                examHistory.style.display = 'none';
                this.textContent = 'üìÑ Anexar PDFs de Exames';
            }
        });

        // Funcionalidade de upload de PDF
        const pdfInput = document.getElementById('pdfInput');
        const uploadZone = document.querySelector('.upload-zone');
        const uploadedFilesContainer = document.getElementById('uploadedFiles');
        const processingStatus = document.getElementById('processingStatus');

        // Eventos de drag and drop
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            handleFileUpload(files);
        });

        // Evento de sele√ß√£o de arquivo
        pdfInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            handleFileUpload(files);
        });

        function handleFileUpload(files) {
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert(`Arquivo ${file.name} √© muito grande. M√°ximo 10MB.`);
                    return;
                }

                const fileId = Date.now() + Math.random();
                const fileObj = {
                    id: fileId,
                    file: file,
                    name: file.name,
                    size: formatFileSize(file.size),
                    status: 'processing',
                    extractedData: null
                };

                uploadedFiles.push(fileObj);
                displayUploadedFiles();
                processPDF(fileObj);
            });
        }

        function displayUploadedFiles() {
            uploadedFilesContainer.innerHTML = '';
            
            uploadedFiles.forEach(fileObj => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">üìÑ</span>
                        <div>
                            <div class="file-name">${fileObj.name}</div>
                            <span class="file-size">${fileObj.size}</span>
                        </div>
                    </div>
                    <div>
                        <span class="file-status status-${fileObj.status}">
                            ${getStatusText(fileObj.status)}
                        </span>
                        <button class="remove-file" onclick="removeFile('${fileObj.id}')">√ó</button>
                    </div>
                `;
                uploadedFilesContainer.appendChild(fileItem);
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'processing': return 'Processando...';
                case 'completed': return 'Processado';
                case 'error': return 'Erro';
                default: return 'Pendente';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function processPDF(fileObj) {
            try {
                processingStatus.style.display = 'flex';
                
                // Simular processamento de PDF com IA
                // Em uma implementa√ß√£o real, isso seria enviado para o backend
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Simular extra√ß√£o de dados do PDF
                const extractedData = {
                    exams: [
                        { name: 'HbA1c', date: '15/07/2024', value: '7.2%' },
                        { name: 'Creatinina', date: '15/07/2024', value: '1.1 mg/dL' }
                    ]
                };
                
                fileObj.status = 'completed';
                fileObj.extractedData = extractedData;
                
                // Adicionar aos exames anteriores
                extractedData.exams.forEach(exam => {
                    examHistory.push({
                        name: exam.name,
                        date: exam.date,
                        value: exam.value,
                        source: 'pdf'
                    });
                });
                
                displayUploadedFiles();
                processingStatus.style.display = 'none';
                
            } catch (error) {
                fileObj.status = 'error';
                displayUploadedFiles();
                processingStatus.style.display = 'none';
                console.error('Erro ao processar PDF:', error);
            }
        }

        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);
            // Remover tamb√©m os exames extra√≠dos deste arquivo
            examHistory = examHistory.filter(exam => exam.source !== 'pdf' || exam.fileId !== fileId);
            displayUploadedFiles();
        }

        document.getElementById('checkupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<div class="loading">Gerando recomenda√ß√µes inteligentes...</div>';
            
            // Coletar dados do formul√°rio
            const formData = new FormData(e.target);
            const data = {
                idade: parseInt(formData.get('idade')),
                sexo: formData.get('sexo'),
                comorbidades: formData.getAll('comorbidades'),
                outras_comorbidades: formData.get('outras_comorbidades'),
                historia_familiar: formData.getAll('historia_familiar'),
                outras_hf: formData.get('outras_hf'),
                tabagismo: {
                    status: formData.get('tabagismo'),
                    macos_ano: parseInt(formData.get('macos_ano')) || 0
                },
                exames_anteriores: examHistory,

                pais: document.getElementById('pais') ? document.getElementById('pais').value : 'BR',
                tabagismo_status: formData.get('tabagismo'),
                tabagismo_macos_ano: parseInt(formData.get('macos_ano')) || 0,
            };
            
            try {
                const response = await fetch('/checkup-intelligent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const recommendations = await response.json();
                displayRecommendations(recommendations);
                
            } catch (error) {
                console.error('Erro:', error);
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <p style="color: #dc2626;">Erro ao gerar recomenda√ß√µes: ${error.message}</p>
                    </div>
                `;
            }
        });
        
        function displayRecommendations(recommendations) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (!recommendations || recommendations.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>Nenhuma recomenda√ß√£o espec√≠fica para este perfil.</p>
                    </div>
                `;
                return;
            }

            // Verificar se h√° alertas
            const alerts = recommendations.alerts || [];
            const recs = recommendations.recommendations || recommendations;
            // Aceita as varia√ß√µes "laboratorio" (sem "al") e "laboratorial" como categorias laboratoriais equivalentes
            const LAB_CATEGORY_VALUES = ['laboratorial', 'laboratorio'];
            const isLaboratoryCategory = categoria => {
                if (!categoria) return false;
                const normalizedCategory = String(categoria).trim().toLowerCase();
                return LAB_CATEGORY_VALUES.includes(normalizedCategory);
            };

            // Salvar recomenda√ß√µes para uso posterior
            lastRecommendations = recs;
            
            // Organizar recomenda√ß√µes por categoria
            const categories = {
                'Exames Laboratoriais': [],
                'Exames de Imagem': [],
                'Rastreamento de C√¢ncer': [],
                'Vacinas': [],
                'Outras Recomenda√ß√µes': []
            };
            
            recs.forEach(item => {
                let category = 'Outras Recomenda√ß√µes';

                if (item.categoria && item.categoria.includes('vacina')) {
                    category = 'Vacinas';
                } else if (item.titulo.toLowerCase().includes('mamografia') ||
                          item.titulo.toLowerCase().includes('colonoscopia') ||
                          item.titulo.toLowerCase().includes('citologia') ||
                          item.titulo.toLowerCase().includes('psa') ||
                          item.titulo.toLowerCase().includes('tomografia')) {
                    category = 'Rastreamento de C√¢ncer';
                } else if (item.titulo.toLowerCase().includes('ultrassom') ||
                          item.titulo.toLowerCase().includes('densitometria') ||
                          item.titulo.toLowerCase().includes('ecocardiograma') ||
                          item.titulo.toLowerCase().includes('eletrocardiograma') ||
                          item.titulo.toLowerCase().includes('fundoscopia')) {
                    category = 'Exames de Imagem';
                } else if (isLaboratoryCategory(item.categoria) ||
                          item.titulo.toLowerCase().includes('hba1c') ||
                          item.titulo.toLowerCase().includes('creatinina') ||
                          item.titulo.toLowerCase().includes('perfil') ||
                          item.titulo.toLowerCase().includes('hemograma') ||
                          item.titulo.toLowerCase().includes('microalbumin√∫ria') ||
                          item.titulo.toLowerCase().includes('hiv') ||
                          item.titulo.toLowerCase().includes('s√≠filis') ||
                          item.titulo.toLowerCase().includes('hepatite') ||
                          item.titulo.toLowerCase().includes('diabetes') ||
                          item.titulo.toLowerCase().includes('glicemia') ||
                          item.titulo.toLowerCase().includes('gonorreia') ||
                          item.titulo.toLowerCase().includes('clam√≠dia') ||
                          item.titulo.toLowerCase().includes('tuberculose') ||
                          item.titulo.toLowerCase().includes('anti-hcv') ||
                          item.titulo.toLowerCase().includes('totg') ||
                          item.titulo.toLowerCase().includes('colesterol') ||
                          item.titulo.toLowerCase().includes('s√≥dio') ||
                          item.titulo.toLowerCase().includes('pot√°ssio') ||
                          item.titulo.toLowerCase().includes('eletr√≥litos') ||
                          item.titulo.toLowerCase().includes('ureia') ||
                          item.titulo.toLowerCase().includes('egfr') ||
                          item.titulo.toLowerCase().includes('albumina') ||
                          item.titulo.toLowerCase().includes('vdrl') ||
                          item.titulo.toLowerCase().includes('hbsag')) {
                    category = 'Exames Laboratoriais';
                }
                
                categories[category].push(item);
            });
            
            let html = '';

            // Mostrar alertas
            if (alerts.length > 0) {
                html += '<div class="alert alert-warning"><strong>‚ö†Ô∏è Alertas:</strong><ul>';
                alerts.forEach(alert => {
                    html += `<li>${alert}</li>`;
                });
                html += '</ul></div>';
            }
            
            Object.keys(categories).forEach(categoryName => {
                if (categories[categoryName].length > 0) {
                    html += `<div class="recommendation-category">
                        <h3 class="category-title">${categoryName}</h3>`;
                    
                    categories[categoryName].forEach((rec, index) => {
                        const statusClass = rec.status ? `status-${rec.status}` : '';
                        const cardClass = rec.status === 'overdue' ? 'overdue' : rec.status === 'recent' ? 'recent' : '';
                        
                        html += `
                            <div class="recommendation-card ${cardClass}" data-rec-id="${rec.titulo}">
                                ${rec.status ? `<div class="exam-status ${statusClass}">${getStatusText(rec.status)}</div>` : ''}
                                <span class="recommendation-priority priority-${rec.prioridade}">${rec.prioridade}</span>
                                <button class="remove-recommendation-btn" onclick="removeRecommendation('${rec.titulo}', this)" title="Excluir esta recomenda√ß√£o">
                                    ‚úï
                                </button>
                                <div class="recommendation-title">${rec.titulo}</div>
                                <div class="recommendation-description">${rec.descricao}</div>
                                <div class="recommendation-reference">${rec.referencia_html ? rec.referencia_html : (rec.referencia || 'USPSTF/ADA/KDIGO/CDC')}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
            });

            // Adicionar a√ß√µes de relat√≥rio
            html += `
                <div class="report-actions">
                     <button class="print-btn" onclick="generateExamRequest()">üìã Solicita√ß√£o de Exames</button>
                <button class="print-btn" onclick="generateVaccineReceipt()">üíâ Receita de Vacinas</button>
                    <button class="btn-report" onclick="generateReport()">üìÑ Relat√≥rio Completo</button>
                    <button class="btn-report" onclick="scheduleReminders()">üîî Agendar Lembretes</button>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
        }

        function getStatusText(status) {
            switch(status) {
                case 'overdue': return 'Em Atraso';
                case 'due': return 'Vencendo';
                case 'recent': return 'Recente';
                default: return '';
            }
        }

        function generatePrescription() {
            if (!lastRecommendations || lastRecommendations.length === 0) {
                alert('Gere as recomenda√ß√µes primeiro!');
                return;
            }
            
            // Coletar dados do paciente
            const patientData = {
                nome: prompt('Nome do paciente:') || 'Paciente',
                idade: document.getElementById('idade').value,
                sexo: document.getElementById('sexo').value
            };
            
            if (!patientData.nome || patientData.nome === 'Paciente') {
                alert('Nome do paciente √© obrigat√≥rio para gerar a prescri√ß√£o!');
                return;
            }
            
            // Chamar API para gerar prescri√ß√£o
            fetch('/gerar-prescricao', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recommendations: lastRecommendations,
                    patient_data: patientData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Erro ao gerar prescri√ß√£o: ' + data.error);
                    return;
                }
                
                // Exibir prescri√ß√£o em nova janela
                const prescriptionWindow = window.open('', '_blank');
                prescriptionWindow.document.write(`
                    <html>
                        <head>
                            <title>Prescri√ß√£o M√©dica - ${patientData.nome}</title>
                            <meta charset="UTF-8">
                            <style>
                                * {
                                    margin: 0;
                                    padding: 0;
                                    box-sizing: border-box;
                                }
                                
                                body {
                                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                    line-height: 1.6;
                                    color: #2d3748;
                                    background: #f7fafc;
                                    padding: 20px;
                                }
                                
                                .prescription-container {
                                    max-width: 800px;
                                    margin: 0 auto;
                                    background: white;
                                    border-radius: 12px;
                                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                                    overflow: hidden;
                                }
                                
                                .prescription-header {
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 30px;
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                }
                                
                                .doctor-info h1 {
                                    font-size: 2rem;
                                    font-weight: 700;
                                    margin-bottom: 5px;
                                }
                                
                                .doctor-info .crm {
                                    font-size: 1.1rem;
                                    opacity: 0.9;
                                    margin-bottom: 3px;
                                }
                                
                                .doctor-info .specialty {
                                    font-size: 0.9rem;
                                    opacity: 0.8;
                                }
                                
                                .prescription-date {
                                    text-align: right;
                                    font-size: 1.1rem;
                                }
                                
                                .patient-info {
                                    background: #edf2f7;
                                    padding: 25px 30px;
                                    border-bottom: 3px solid #e2e8f0;
                                }
                                
                                .patient-info h2 {
                                    color: #2d3748;
                                    font-size: 1.3rem;
                                    margin-bottom: 15px;
                                    display: flex;
                                    align-items: center;
                                }
                                
                                .patient-info h2:before {
                                    content: "üë§";
                                    margin-right: 10px;
                                }
                                
                                .patient-details {
                                    display: grid;
                                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                                    gap: 15px;
                                }
                                
                                .patient-details p {
                                    background: white;
                                    padding: 12px 15px;
                                    border-radius: 8px;
                                    border-left: 4px solid #667eea;
                                }
                                
                                .prescription-content {
                                    padding: 30px;
                                }
                                
                                .prescription-content h2 {
                                    color: #2d3748;
                                    font-size: 1.5rem;
                                    margin-bottom: 25px;
                                    text-align: center;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #e2e8f0;
                                }
                                
                                .exam-category {
                                    margin-bottom: 30px;
                                }
                                
                                .exam-category h3 {
                                    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
                                    color: white;
                                    padding: 15px 20px;
                                    border-radius: 8px;
                                    font-size: 1.2rem;
                                    margin-bottom: 15px;
                                }
                                
                                .exam-list {
                                    display: grid;
                                    gap: 15px;
                                }
                                
                                .exam-item {
                                    background: #f7fafc;
                                    border: 1px solid #e2e8f0;
                                    border-radius: 8px;
                                    padding: 20px;
                                    transition: all 0.3s ease;
                                }
                                
                                .exam-item:hover {
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                                    transform: translateY(-2px);
                                }
                                
                                .exam-header {
                                    display: flex;
                                    align-items: center;
                                    margin-bottom: 12px;
                                }
                                
                                .exam-number {
                                    background: #667eea;
                                    color: white;
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    margin-right: 15px;
                                }
                                
                                .exam-title {
                                    font-weight: 600;
                                    font-size: 1.1rem;
                                    color: #2d3748;
                                    flex: 1;
                                }
                                
                                .priority-badge {
                                    font-size: 1.2rem;
                                }
                                
                                .exam-details {
                                    margin-left: 45px;
                                }
                                
                                .exam-details p {
                                    margin-bottom: 8px;
                                    font-size: 0.95rem;
                                }
                                
                                .indication {
                                    color: #4a5568;
                                }
                                
                                .reference {
                                    color: #718096;
                                    font-style: italic;
                                }
                                
                                .prescription-footer {
                                    background: #edf2f7;
                                    padding: 30px;
                                    border-top: 3px solid #e2e8f0;
                                }
                                
                                .instructions {
                                    margin-bottom: 30px;
                                }
                                
                                .instructions h3 {
                                    color: #2d3748;
                                    font-size: 1.2rem;
                                    margin-bottom: 15px;
                                }
                                
                                .instructions ul {
                                    list-style: none;
                                    padding-left: 0;
                                }
                                
                                .instructions li {
                                    background: white;
                                    padding: 12px 15px;
                                    margin-bottom: 8px;
                                    border-radius: 6px;
                                    border-left: 4px solid #48bb78;
                                    position: relative;
                                    padding-left: 40px;
                                }
                                
                                .instructions li:before {
                                    content: "‚úì";
                                    position: absolute;
                                    left: 15px;
                                    color: #48bb78;
                                    font-weight: bold;
                                }
                                
                                .signature {
                                    text-align: center;
                                    margin-top: 40px;
                                }
                                
                                .signature-line {
                                    width: 300px;
                                    height: 2px;
                                    background: #2d3748;
                                    margin: 0 auto 15px;
                                }
                                
                                .doctor-signature {
                                    font-size: 1.2rem;
                                    font-weight: 600;
                                    color: #2d3748;
                                    margin-bottom: 5px;
                                }
                                
                                .crm-signature {
                                    color: #718096;
                                    font-size: 1rem;
                                }
                                
                                .print-actions {
                                    position: fixed;
                                    top: 20px;
                                    right: 20px;
                                    display: flex;
                                    gap: 10px;
                                    z-index: 1000;
                                }
                                
                                .print-btn {
                                    padding: 12px 20px;
                                    background: #667eea;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                                }
                                
                                .print-btn:hover {
                                    background: #5a67d8;
                                    transform: translateY(-2px);
                                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
                                }
                                
                                .close-btn {
                                    background: #e53e3e;
                                }
                                
                                .close-btn:hover {
                                    background: #c53030;
                                }
                                
                                @media print {
                                    body {
                                        background: white;
                                        padding: 0;
                                    }
                                    
                                    .print-actions {
                                        display: none;
                                    }
                                    
                                    .prescription-container {
                                        box-shadow: none;
                                        border-radius: 0;
                                    }
                                }
                                
                                @media (max-width: 768px) {
                                    .prescription-header {
                                        flex-direction: column;
                                        text-align: center;
                                    }
                                    
                                    .prescription-date {
                                        text-align: center;
                                        margin-top: 15px;
                                    }
                                    
                                    .patient-details {
                                        grid-template-columns: 1fr;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="print-actions">
                                <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                                <button class="print-btn close-btn" onclick="window.close()">‚úñÔ∏è Fechar</button>
                            </div>
                            
                            <div class="prescription-container">
                                ${data.prescricao}
                            </div>
                        </body>
                    </html>
                `);
                prescriptionWindow.document.close();
            })
            .catch(error => {
                alert('Erro ao gerar prescri√ß√£o: ' + error.message);
            });
        }

        function generateExamRequest() {
            console.log('generateExamRequest chamada');
            
            const activeRecommendations = getActiveRecommendations();
            if (!activeRecommendations || activeRecommendations.length === 0) {
                alert('Gere as recomenda√ß√µes primeiro ou todas foram removidas.');
                return;
            }

            const patientData = {
                nome: prompt('Nome do paciente:') || 'Paciente',
                idade: document.getElementById('idade').value,
                sexo: document.getElementById('sexo').value
            };
            
            console.log('Dados do paciente:', patientData);
            console.log('Recomenda√ß√µes ativas:', activeRecommendations.length);

            fetch('/gerar-solicitacao-exames', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recommendations: activeRecommendations,
                    patient_data: patientData
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Erro ao gerar solicita√ß√£o de exames: ' + response.status);
                }
                return response.text();
            })
            .then(html => {
                console.log('HTML recebido, abrindo nova janela...');
                // Abrir nova janela com HTML
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(html);
                    newWindow.document.close();
                    console.log('Nova janela aberta com sucesso');
                } else {
                    alert('N√£o foi poss√≠vel abrir nova janela. Verifique se pop-ups est√£o bloqueados.');
                }
            })
            .catch(error => {
                console.error('Erro completo:', error);
                alert('Erro ao gerar solicita√ß√£o de exames: ' + error.message);
            });
        }

        function generateVaccineReceipt() {
            console.log('generateVaccineReceipt chamada');
            
            const activeRecommendations = getActiveRecommendations();
            if (!activeRecommendations || activeRecommendations.length === 0) {
                alert('Gere as recomenda√ß√µes primeiro ou todas foram removidas.');
                return;
            }

            const patientData = {
                nome: prompt('Nome do paciente:') || 'Paciente',
                idade: document.getElementById('idade').value,
                sexo: document.getElementById('sexo').value
            };
            
            console.log('Dados do paciente:', patientData);
            console.log('Recomenda√ß√µes ativas:', activeRecommendations.length);

            fetch('/gerar-receita-vacinas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recommendations: activeRecommendations,
                    patient_data: patientData
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Erro ao gerar receita de vacinas: ' + response.status);
                }
                return response.text();
            })
            .then(html => {
                console.log('HTML recebido, abrindo nova janela...');
                // Abrir nova janela com HTML
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(html);
                    newWindow.document.close();
                    console.log('Nova janela aberta com sucesso');
                } else {
                    alert('N√£o foi poss√≠vel abrir nova janela. Verifique se pop-ups est√£o bloqueados.');
                }
            })
            .catch(error => {
                console.error('Erro completo:', error);
                alert('Erro ao gerar receita de vacinas: ' + error.message);
            });
        }

        function generateReport() {
            alert('Funcionalidade de relat√≥rio ser√° implementada em breve!');
        }

        function scheduleReminders() {
            alert('Funcionalidade de lembretes ser√° implementada em breve!');
        }

        // Array para armazenar recomenda√ß√µes removidas
        let removedRecommendations = [];

        function removeRecommendation(titulo, buttonElement) {
            if (confirm(`Tem certeza que deseja excluir "${titulo}" das recomenda√ß√µes?`)) {
                // Adicionar √† lista de removidos
                removedRecommendations.push(titulo);
                
                // Marcar o card como removido visualmente
                const card = buttonElement.closest('.recommendation-card');
                card.classList.add('removed');
                
                // Remover da lista de recomenda√ß√µes ativas
                if (lastRecommendations) {
                    lastRecommendations = lastRecommendations.filter(rec => rec.titulo !== titulo);
                }
                
                // Feedback visual
                setTimeout(() => {
                    card.style.display = 'none';
                }, 300);
                
                console.log(`Recomenda√ß√£o "${titulo}" removida. Total removidas: ${removedRecommendations.length}`);
            }
        }

         // L√≥gica de depend√™ncia entre HAS e HAS Resistente
        document.getElementById('has_resistente').addEventListener('change', function() {
            const hasResistente = this.checked;
            const hipertensao = document.getElementById('hipertensao');
            
            if (hasResistente) {
                // Se HAS Resistente for marcada, marcar automaticamente Hipertens√£o
                hipertensao.checked = true;
            }
        });
        
        document.getElementById('hipertensao').addEventListener('change', function() {
            const hipertensao = this.checked;
            const hasResistente = document.getElementById('has_resistente');
            
            if (!hipertensao) {
                // Se Hipertens√£o for desmarcada, desmarcar automaticamente HAS Resistente
                hasResistente.checked = false;
            }
        });

        function generateRecommendations() {
            const idade = document.getElementById('idade').value;
            const sexo = document.getElementById('sexo').value;
            const pais = document.getElementById('pais').value;
            
            if (!idade || !sexo) {
                alert('Por favor, preencha idade e sexo.');
                return;
            }

            // Coleta comorbidades
            const comorbidades = [];
            document.querySelectorAll('input[name="comorbidades"]:checked').forEach(checkbox => {
                comorbidades.push(checkbox.value);
            });

            // Coleta hist√≥ria familiar
            const historiaFamiliar = [];
            document.querySelectorAll('input[name="historia_familiar"]:checked').forEach(checkbox => {
                historiaFamiliar.push(checkbox.value);
            });

            // Coleta outras informa√ß√µes
            const outrasComorbidades = document.getElementById('outras_comorbidades').value;
            const medicacoes = document.getElementById('medicacoes').value;
            const outrasCondicoesFamiliares = document.getElementById('outras_condicoes_familiares').value;
            const tabagismo = document.getElementById('tabagismo').value;
            const macosAno = document.getElementById('macos_ano').value;

            const data = {
                idade: parseInt(idade),
                sexo: sexo,
                pais: pais,
                comorbidades: comorbidades,
                historia_familiar: historiaFamiliar,
                outras_comorbidades: outrasComorbidades,
                medicacoes: medicacoes,
                outras_condicoes_familiares: outrasCondicoesFamiliares,
                tabagismo: tabagismo,
                macos_ano: macosAno ? parseInt(macosAno) : 0
            };

            console.log('Dados enviados:', data);

            fetch('/recomendacoes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Recomenda√ß√µes recebidas:', data);
                lastRecommendations = data.recomendacoes;
                removedRecommendations = []; // Reset removed recommendations
                displayRecommendations(data.recomendacoes);
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao gerar recomenda√ß√µes: ' + error.message);
            });
        }

        function getActiveRecommendations() {
            // Retorna apenas as recomenda√ß√µes que n√£o foram removidas
            if (!lastRecommendations) return [];
            return lastRecommendations.filter(rec => !removedRecommendations.includes(rec.titulo));
        }
    
        function renderStatusChip(status) {
            if (!status) return '';
            const cls = status.includes('atraso') ? 'status-overdue' : (status.includes('Devido') || status.includes('devido') ? 'status-due' : 'status-recent');
            return `<span class="exam-status ${cls}">${status}</span>`;
        }

        // ===== FUN√á√ïES PREVENT PARA C√ÅLCULO DE RISCO CARDIOVASCULAR =====
        
        function calculateEGFR(creatinine, age, sex) {
            // Equa√ß√£o CKD-EPI 2021 sem ra√ßa
            const isFemale = sex === 'feminino';
            const kappa = isFemale ? 0.7 : 0.9;
            const alpha = isFemale ? -0.241 : -0.302;
            const minCr = Math.min(creatinine / kappa, 1);
            const maxCr = Math.max(creatinine / kappa, 1);
            
            return 142 * Math.pow(minCr, alpha) * Math.pow(maxCr, -1.200) * Math.pow(0.9938, age) * (isFemale ? 1.012 : 1);
        }

        function calculateBMI(weight, height) {
            const heightM = height / 100;
            return weight / (heightM * heightM);
        }

        function getPREVENTCoefficients(sex, outcome = 'total_cvd') {
            // Coefficients pour Total CVD 10 ans
            const coefficients = {
                feminino: {
                    constant: -3.307728,
                    age: 0.7939329,
                    nonHDL: 0.0305239,
                    hdl: -0.1606857,
                    sbpLow: -0.2394003,
                    sbpHigh: 0.360078,
                    diabetes: 0.8667604,
                    smoking: 0.5360739,
                    egfrLow: 0.6045917,
                    egfrHigh: 0.0433769,
                    antihtn: 0.3151672,
                    statin: -0.1477655,
                    antihtnSBP: -0.0663612,
                    statinNonHDL: 0.1197879,
                    ageNonHDL: -0.0819715,
                    ageHDL: 0.0306769,
                    ageSBP: -0.0946348,
                    ageDiabetes: -0.27057,
                    ageSmoking: -0.078715,
                    ageEGFR: -0.1637806
                },
                masculino: {
                    constant: -3.031168,
                    age: 0.7688528,
                    nonHDL: 0.0736174,
                    hdl: -0.0954431,
                    sbpLow: -0.4347345,
                    sbpHigh: 0.3362658,
                    diabetes: 0.7692857,
                    smoking: 0.4386871,
                    egfrLow: 0.5378979,
                    egfrHigh: 0.0164827,
                    antihtn: 0.288879,
                    statin: -0.1337349,
                    antihtnSBP: -0.0475924,
                    statinNonHDL: 0.150273,
                    ageNonHDL: -0.0517874,
                    ageHDL: 0.0191169,
                    ageSBP: -0.1049477,
                    ageDiabetes: -0.2251948,
                    ageSmoking: -0.0895067,
                    ageEGFR: -0.1543702
                }
            };
            
            return coefficients[sex];
        }

        function calculatePREVENTRisk(patientData) {
            const {
                age, sex, totalCholesterol, hdlCholesterol, 
                systolicBP, diabetes, smoking, weight, height,
                creatinine, antihypertensiveMeds, statins
            } = patientData;
            
            // Valida√ß√µes b√°sicas
            if (!age || !sex || !totalCholesterol || !hdlCholesterol || !systolicBP || !creatinine) {
                return null;
            }
            
            // Calculs d√©riv√©s
            const bmi = weight && height ? calculateBMI(weight, height) : null;
            const egfr = calculateEGFR(creatinine, age, sex);
            
            // Transformations des variables
            const ageTransformed = (age - 55) / 10;
            const nonHDLTransformed = (totalCholesterol - hdlCholesterol) * 0.02586 - 3.5;
            const hdlTransformed = (hdlCholesterol * 0.02586 - 1.3) / 0.3;
            const sbpLowTransformed = (Math.min(systolicBP, 110) - 110) / 20;
            const sbpHighTransformed = (Math.max(systolicBP, 110) - 130) / 20;
            const egfrLowTransformed = (Math.min(egfr, 60) - 60) / -15;
            const egfrHighTransformed = (Math.max(egfr, 60) - 90) / -15;
            
            // Obtenir les coefficients
            const coefficients = getPREVENTCoefficients(sex);
            
            // Calcul du log-odds
            let logOdds = coefficients.constant;
            logOdds += coefficients.age * ageTransformed;
            logOdds += coefficients.nonHDL * nonHDLTransformed;
            logOdds += coefficients.hdl * hdlTransformed;
            logOdds += coefficients.sbpLow * sbpLowTransformed;
            logOdds += coefficients.sbpHigh * sbpHighTransformed;
            logOdds += coefficients.diabetes * (diabetes ? 1 : 0);
            logOdds += coefficients.smoking * (smoking ? 1 : 0);
            logOdds += coefficients.egfrLow * egfrLowTransformed;
            logOdds += coefficients.egfrHigh * egfrHighTransformed;
            logOdds += coefficients.antihtn * (antihypertensiveMeds ? 1 : 0);
            logOdds += coefficients.statin * (statins ? 1 : 0);
            
            // Interactions
            logOdds += coefficients.antihtnSBP * (antihypertensiveMeds ? 1 : 0) * sbpHighTransformed;
            logOdds += coefficients.statinNonHDL * (statins ? 1 : 0) * nonHDLTransformed;
            logOdds += coefficients.ageNonHDL * ageTransformed * nonHDLTransformed;
            logOdds += coefficients.ageHDL * ageTransformed * hdlTransformed;
            logOdds += coefficients.ageSBP * ageTransformed * sbpHighTransformed;
            logOdds += coefficients.ageDiabetes * ageTransformed * (diabetes ? 1 : 0);
            logOdds += coefficients.ageSmoking * ageTransformed * (smoking ? 1 : 0);
            logOdds += coefficients.ageEGFR * ageTransformed * egfrLowTransformed;
            
            // Calcul du risque
            const risk10Year = Math.exp(logOdds) / (1 + Math.exp(logOdds)) * 100;
            
            // Estimation approximative du risque 30 ans (facteur 2.5-3x)
            const risk30Year = Math.min(risk10Year * 2.8, 85);
            
            return {
                risk10Year: Math.round(risk10Year * 10) / 10,
                risk30Year: Math.round(risk30Year * 10) / 10,
                egfr: Math.round(egfr),
                bmi: bmi ? Math.round(bmi * 10) / 10 : null
            };
        }

        function getRiskInterpretation(risk10Year) {
            if (risk10Year < 5) {
                return { level: 'low', text: 'Baixo Risco. Manter estilo de vida saud√°vel e acompanhamento de rotina.' };
            } else if (risk10Year < 7.5) {
                return { level: 'borderline', text: 'Risco Borderline. Considerar biomarqueurs para refinamento da avalia√ß√£o.' };
            } else if (risk10Year < 20) {
                return { level: 'intermediate', text: 'Risco Intermedi√°rio. Biomarqueurs recomendados e interven√ß√£o terap√™utica.' };
            } else {
                return { level: 'high', text: 'Alto Risco. Interven√ß√£o terap√™utica urgente e acompanhamento especializado.' };
            }
        }

        function updatePREVENTRiskDisplay() {
            // Coletar dados do formul√°rio
            const formData = new FormData(document.getElementById('checkupForm'));
            
            const patientData = {
                age: parseInt(formData.get('idade')),
                sex: formData.get('sexo'),
                totalCholesterol: parseFloat(formData.get('colesterol_total')),
                hdlCholesterol: parseFloat(formData.get('hdl_colesterol')),
                systolicBP: parseFloat(formData.get('pressao_sistolica')),
                diabetes: formData.getAll('comorbidades').includes('diabetes_tipo_2'),
                smoking: formData.get('tabagismo') === 'fumante_atual',
                weight: parseFloat(formData.get('peso')),
                height: parseFloat(formData.get('altura')),
                creatinine: parseFloat(formData.get('creatinina')),
                antihypertensiveMeds: formData.getAll('medicamentos_estruturados').includes('anti_hipertensivo'),
                statins: formData.getAll('medicamentos_estruturados').includes('estatina')
            };
            
            // Calcular risque
            const riskResult = calculatePREVENTRisk(patientData);
            
            const riskSection = document.getElementById('preventRiskSection');
            const risk10Element = document.getElementById('risk-10-year');
            const risk30Element = document.getElementById('risk-30-year');
            const interpretationElement = document.getElementById('riskInterpretationText');
            
            if (riskResult) {
                // Afficher la section
                riskSection.style.display = 'block';
                
                // Mettre √† jour les valeurs
                risk10Element.textContent = riskResult.risk10Year + '%';
                risk30Element.textContent = riskResult.risk30Year + '%';
                
                // Mettre √† jour le champ hidden pour le backend
                document.getElementById('prevent_risk_10yr').value = riskResult.risk10Year;
                
                // Mettre √† jour les couleurs selon le niveau de risque
                const interpretation = getRiskInterpretation(riskResult.risk10Year);
                risk10Element.className = `risk-percentage ${interpretation.level}`;
                risk30Element.className = `risk-percentage ${interpretation.level}`;
                
                // Mettre √† jour l'interpr√©tation
                interpretationElement.textContent = interpretation.text;
                
                console.log('Risque PREVENT calcul√©:', riskResult);
            } else {
                // Masquer la section si donn√©es insuffisantes
                riskSection.style.display = 'none';
                // Vider le champ hidden si pas de donn√©es
                document.getElementById('prevent_risk_10yr').value = '';
            }
        }

        // Ajouter des √©couteurs d'√©v√©nements pour recalculer automatiquement
        document.addEventListener('DOMContentLoaded', function() {
            const clinicalFields = [
                'idade', 'sexo', 'peso', 'altura', 'pressao_sistolica', 
                'colesterol_total', 'hdl_colesterol', 'creatinina',
                'diabetes', 'tabagismo', 'medicamento_hipertensao', 'medicamento_estatina'
            ];
            
            clinicalFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', updatePREVENTRiskDisplay);
                    field.addEventListener('input', updatePREVENTRiskDisplay);
                }
            });
        });
        
</script>
</body>
</html>

